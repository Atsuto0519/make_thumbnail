#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#include "def.h"
#include "var.h"
#include "bmpfile.h"

#define Zm 255

void quadratic_LUT(double LUT[Zm+1]){
  int i;

  for(i=0; i<=Zm; i++){
    LUT[i] = (i*i)/Zm;
  }
}

void root_convert_LUT(double LUT[Zm+1]){
  int i;

  for(i=0; i<=Zm; i++){
    LUT[i] = sqrt(i*Zm);
  }
}

void sigmoid_convert_LUT(double a, double LUT[Zm+1]){
  int i;
  double x;

  for(i=0; i<=Zm; i++){
    x=(double)i/Zm-0.5;
    x=(double)-7.0*x;
    x=(double)1.0+exp(x);
    LUT[i] = (double)Zm/x;
  }
}

void init_array(int color_distribution[Zm+1]){
  int i;
  
  for(i=0; i<=Zm; i++){
    color_distribution[i]=0;
  }
}

void analysis_distribution(int nm[][Zm+1], int color_distribution[Zm+1]){
  int i,j,cnt;
  int a;
  
  cnt=0;
  for(i=0; i<=Zm; i++){
    cnt+=color_distribution[i];
  }
  for(i=0; i<=Zm; i++){
    printf("distribution=%d\n",color_distribution[i]);
  }
  printf("ave=%d\n",cnt);
}

int main(int argc, char *argv[])
{
  imgdata idata;
  int x, y, i, j;
  int i_tmp, j_tmp;
  int n = 5, N, sum;
  int converted[Zm+1][Zm+1] = {{0}};
  int i_max, j_max;
 
  
  // 課題プログラム
  // 　BMPファイルを平均値フィルタ変換するプログラム

  if (argc < 3) printf("使用法：mean_value_filterbmp 変換元.bmp 変換先.bmp\n");
  else {
    if (readBMPfile(argv[1], &idata) > 0)
      printf("指定変換元ファイル%sが見つかりません\n",argv[1]);
    else {
    /* 課題７：平均値フィルタ変換するプログラム */
      for (y = 0; y < idata.height; y++){
	for (x = 0; x < idata.width; x++){
	  N = 0;
	  sum = 0;
	  i_max = 2;
	  j_max = 2;
	  i_tmp = -1;
	  j_tmp = -1;
	  
	  if (x == 0){
	    i_tmp = 0;
	  }if (y == 0){
	    j_tmp = 0;
	  }if (x == idata.width-1){
	    i_max = 1;
	  }if (y == idata.height-1){
	    j_max = 1;
	  }
	  
	  for (j = j_tmp; j < j_max; j++){
	    for (i = i_tmp; i < i_max; i++){
	      N++;
	      if (i == 0 && j == 0){
		sum += n*idata.source[RED][y+j][x+i];
	      }else{
		sum += idata.source[RED][y+j][x+i];
	      }
	    }
	  }
	  sum /= (n+N-1);
	  idata.results[RED][y][x] = sum;
	  idata.results[GREEN][y][x] = sum;
	  idata.results[BLUE][y][x] = sum;
	}
      }
	
      if (writeBMPfile(argv[2], &idata) > 0)
	printf("変換先ファイル%sに保存できませんでした\n",argv[2]);
    }
  }
}
